---
title: "Sampling Methods"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
setwd("../sim_output")
data <- read_tsv('sim_table_plus_all.tsv')
```

## Including Plots

You can also embed plots, for example:

```{r groupsizes, fig.width=10, fig.height=10}
ggplot(data=data, mapping=aes(x=method,y=prop_d_a-trueprop_d_a)) + 
  geom_violin() + 
  facet_grid(h_a~trueprop_d_a) +
  ylab("Error in Measurement of Group A Proportion") +
  xlab("Sampling Method") +
  theme(axis.text.x=element_text(angle=90,vjust=.5)) +
  ggtitle("Error in Proportion of Group A by Sampling Method and True Proportion")
```
```{r groupsizes2, fig.width=10, fig.height=10}
ggplot(data=data, mapping=aes(x=method,y=prop_d_aa-trueprop_d_aa)) + 
  geom_violin() + 
  facet_grid(h_a~trueprop_d_a) +
  ylab("Error in Measurement of Group A Proportion") +
  xlab("Sampling Method") +
  theme(axis.text.x=element_text(angle=90,vjust=.5)) +
  ggtitle("Error in Proportion of Group A by Sampling Method, Homophily, and True Proportion")
```


### Methods for Recovering Node Proportions

#### RMSE for Proportion of A Nodes

```{r by_method_by_params_node_rmse}
  group_by(data, method) %>% 
  summarize(rmse = sqrt(mean((trueprop_d_a-prop_d_a)^2))) %>% 
  arrange(rmse)
```
We would expect that a simple random sample of nodes would be lowest variance way of recovering node proportions, and the simulation data bears this out. Reweighted Random Walk is the next best performer. Other methods such as sampling ego networks and edge sampling perform significantly worse.
**TODO: Is it significant? It must be, right?**

#### Breakdown of Error by Graph Parameters

```{r by_method_by_params_node_err, fig.width=10, fig.height = 10}
by_method <- filter(data,method != "population") %>% 
  group_by(method, h_a, trueprop_d_a) %>%
  summarize(err_sd = sd(trueprop_d_a-prop_d_a), err_mean = mean(trueprop_d_a-prop_d_a))
ggplot(data = by_method, mapping=aes(x = interaction(h_a,trueprop_d_a), col=method)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_pointrange(mapping = aes(ymin=err_mean - err_sd, ymax = err_mean + err_sd, y = err_mean), position=position_dodge(width = .6)) +
  ylab("Mean Error ± One Standard Deviation") +
  xlab("A-Homophily Parameter and True Population Proportion of A") +
  ggtitle("Mean Error in Population Proportion of A by Graph Parameters and Sampling Method")
```

### Methods for Recovering Link Proportions
We would expect that a simple random sample of edges would be lowest variance way of recovering link proportions, and the simulation data bears this out. Random walk is the next best performer. RWRW is not included since no reweighting is necessary in this case.

#### RMSE for Proportion of A-A Links

```{r by_method_by_params_link_rmse}
filter(data, method != "sample_RWRW") %>% 
  group_by(method) %>% 
  summarize(rmse = sqrt(mean((trueprop_d_aa-prop_d_aa)^2))) %>% 
  arrange(rmse)
```
Breaking down the performance of the sampling methodus across graph parameters shows that edge sampling and random walk sampling provide unbiased-looking estimates across graph parameters, though edge sampling results in lower variance.
**TODO:** Formal test of whether things are biased?

#### Breakdown of Error by Graph Parameters

```{r by_method_by_params_link_err, fig.width=10, fig.height = 10}
by_method <- filter(data,method != "population") %>% 
  group_by(method, h_a, trueprop_d_a) %>%
  summarize(err_sd = sd(trueprop_d_aa-prop_d_aa), err_mean = mean(trueprop_d_aa-prop_d_aa))
ggplot(data = by_method, mapping=aes(x = interaction(h_a,trueprop_d_a), col=method)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_pointrange(mapping = aes(ymin=err_mean - err_sd, ymax = err_mean + err_sd, y = err_mean), position=position_dodge(width = .6)) +
  ylab("Mean Error ± One Standard Deviation") +
  xlab("A-Homophily Parameter and True Population Proportion of A") +
  ggtitle("Mean Error in Population Proportion of A-A links by Graph Parameters and Sampling Method")
```

### Tradeoff Space Between Link Proportion and Node Proportion Recovery

Most measures of homophily require knowledge of both link and node proportions. Some methods perform better at measuring one or the other of these attributes of the graph so, there is a there is a tradeoff to be navigated.
```{r bymethod, fig.width=10, fig.height=10}
by_method <- group_by(data, method) %>% 
  summarize(rmse_d_a = sqrt(mean((trueprop_d_a-prop_d_a)^2)),
            rmse_d_b = sqrt(mean((trueprop_d_b-prop_d_b)^2)),
            rmse_d_aa = sqrt(mean((trueprop_d_aa-prop_d_aa)^2)),
            rmse_d_ab = sqrt(mean((trueprop_d_ab-prop_d_ab)^2)),
            rmse_d_ba = sqrt(mean((trueprop_d_ba-prop_d_ba)^2)),
            rmse_d_bb = sqrt(mean((trueprop_d_bb-prop_d_bb)^2)))
ggplot(data = by_method, mapping=aes(x=1-rmse_d_a,y=1-rmse_d_aa,col=method)) +
  geom_point(size=5) +
  geom_vline(xintercept = 1, linetype="dashed") +
  geom_hline(yintercept = 1, linetype="dashed") +
  coord_fixed(xlim = c(.85,1), ylim = c(.85,1)) +
  ylab("1-RMSE of A-A Link Proportions") +
  xlab("1-RMSE of A Node Proportions") +
  ggtitle("RMSE Tradeoff for Link and Node Measurements")
```
In this tradeoff space, Reweighted Random Walk has the lowest distance from the optimal position
```{r bymethodbyparams, fig.height=10, fig.width=10}
# by_method <- group_by(data, method, h_a, trueprop_d_a) %>% 
#   summarize(rmse_d_a = sqrt(mean((trueprop_d_a-prop_d_a)^2)),
#             rmse_d_b = sqrt(mean((trueprop_d_b-prop_d_b)^2)),
#             rmse_d_aa = sqrt(mean((trueprop_d_aa-prop_d_aa)^2)),
#             rmse_d_ab = sqrt(mean((trueprop_d_ab-prop_d_ab)^2)),
#             rmse_d_ba = sqrt(mean((trueprop_d_ba-prop_d_ba)^2)),
#             rmse_d_bb = sqrt(mean((trueprop_d_bb-prop_d_bb)^2)))
# ggplot(data = by_method, mapping=aes(x=1-rmse_d_a,y=1-rmse_d_aa,col=method)) +
#   geom_point(size=5) +
#   facet_grid(h_a~trueprop_d_a) +
#   geom_vline(xintercept = 1, linetype="dashed") +
#   geom_hline(yintercept = 1, linetype="dashed") +
#   coord_fixed(xlim = c(.75,1), ylim = c(.75,1)) +
#   ylab("1-RMSE of A-A Link Proportions") +
#   xlab("1-RMSE of A Node Proportions") +
#   ggtitle("RMSE Tradeoff for Link and Node Measurements by Graph Parameters")
```

```{r coleman}
coleman <- mutate(data, h_aa = prop_d_aa/(prop_d_aa+prop_d_ab), true_h_aa = trueprop_d_aa/(trueprop_d_aa+trueprop_d_ab)) %>%
  mutate(coleman_aa = ifelse(h_aa > prop_d_a,(h_aa - prop_d_a)/(1-prop_d_a),(h_aa - prop_d_a)/prop_d_a), true_coleman_aa = ifelse(true_h_aa > trueprop_d_a,(true_h_aa- trueprop_d_a)/(1-trueprop_d_a),(true_h_aa- trueprop_d_a)/trueprop_d_a))

# coleman <- filter(coleman, !is.na(true_coleman_aa) & !is.na(coleman_aa)) %>%
#   group_by(method) %>%
#   summarize(rmse_coleman_err_aa = sqrt(mean((true_coleman_aa-coleman_aa)^2))) %>%
#   arrange(rmse_coleman_err_aa)
# coleman

ggplot(data = coleman, mapping=aes(x = method, y = coleman_aa-true_coleman_aa, col = method)) +
  geom_violin() +
  facet_grid(trueprop_d_a~h_a)
  
```